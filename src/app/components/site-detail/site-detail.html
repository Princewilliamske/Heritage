<div *ngIf="site() as siteData; else notFound" class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-lg animate-fade-in">
  <div class="mb-6">
    <a routerLink="/sites" class="inline-flex items-center text-amber-800 hover:text-amber-950 transition-colors font-medium">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
      </svg>
      Back to Historical Sites
    </a>
  </div>

  <h2 class="text-4xl font-extrabold font-serif text-stone-900 mb-4 tracking-tight">{{ siteData.name }}</h2>
  
  <div class="flex items-center text-lg text-stone-600 mb-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-amber-700" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
    </svg>
    <span>{{ siteData.location }}</span>
  </div>

  <img [src]="siteData.imageUrl.replace('/400/300', '/800/600')" [alt]="siteData.name" class="w-full h-auto md:h-[450px] object-cover rounded-lg shadow-md mb-8" />
  
  <!-- Main Description -->
  <div class="prose prose-lg max-w-none text-stone-700 mb-10">
    <p class="leading-relaxed">{{ siteData.description }}</p>
  </div>
  
  <!-- Rating Section -->
  <div class="my-10 p-6 rounded-lg bg-amber-50/50 border border-amber-200">
    <h3 class="text-2xl font-bold text-amber-900 mb-4 text-center">Rate This Site</h3>
    <div class="flex flex-col items-center gap-3">
      <div class="flex items-center" (mouseleave)="hoverRating.set(0)">
        <button *ngFor="let star of stars; let i = index" 
                (mouseover)="hoverRating.set(i + 1)"
                (click)="rate(i + 1)"
                class="text-stone-300 hover:text-yellow-400 transition-colors focus:outline-none"
                [ngClass]="{'!text-yellow-400': (hoverRating() > 0 && (i + 1) <= hoverRating()) || (hoverRating() === 0 && (i + 1) <= userRating())}"
                [attr.aria-label]="'Rate ' + (i + 1) + ' stars'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor">
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
          </svg>
        </button>
      </div>
      <p class="text-stone-600 font-medium text-lg">
        Average Rating: {{ displayData().average }}
        <span class="text-stone-500 font-normal"> ({{ displayData().count }} votes)</span>
      </p>
      <p *ngIf="userRating() > 0" class="text-sm text-green-800 bg-green-100 px-3 py-1 rounded-full">
        You rated this {{ userRating() }} star{{ userRating() > 1 ? 's' : '' }}.
      </p>
    </div>
  </div>


  <!-- AI Enrichment Section -->
  <div class="mt-10 p-6 rounded-lg bg-green-50/50 border border-green-200">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-2xl font-bold text-green-900 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 mr-3"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" /></svg>
        Ask Kazi for More...
      </h3>
       <button *ngIf="aiConversation().length > 0" (click)="resetAiInteraction()" class="px-3 py-1 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium text-xs">Reset</button>
    </div>
    
    <!-- Initial Prompt Buttons -->
    <div *ngIf="aiConversation().length === 0 && !isGenerating()" class="flex flex-wrap gap-3">
      <button (click)="getAiEnrichment('expand')" class="px-4 py-2 bg-green-800 text-white rounded-lg hover:bg-green-900 transition-colors font-medium">Tell Me More</button>
      <button (click)="getAiEnrichment('summarize')" class="px-4 py-2 bg-white border border-green-800 text-green-800 rounded-lg hover:bg-green-100 transition-colors font-medium">Summarize This</button>
      <button (click)="getAiEnrichment('fact')" class="px-4 py-2 bg-white border border-green-800 text-green-800 rounded-lg hover:bg-green-100 transition-colors font-medium">Share a Fun Fact</button>
    </div>

    <!-- Loading Skeleton -->
    <div *ngIf="isGenerating() && aiConversation().length === 0" class="animate-pulse">
      <div class="space-y-3">
        <div class="h-4 bg-green-200 rounded w-full"></div>
        <div class="h-4 bg-green-200 rounded w-11/12"></div>
        <div class="h-4 bg-green-200 rounded w-4/5"></div>
        <div class="space-y-3 mt-5">
          <div class="h-4 bg-green-200 rounded w-full"></div>
          <div class="h-4 bg-green-200 rounded w-5/6"></div>
        </div>
      </div>
    </div>
    
    <!-- AI Conversation -->
    <div *ngIf="aiConversation().length > 0" class="space-y-4">
      <div *ngFor="let msg of aiConversation()">
        <div [ngClass]="{'bg-green-100/60': msg.role === 'bot', 'bg-amber-100/60': msg.role === 'user'}" class="p-4 rounded-lg">
          <p class="font-bold text-sm uppercase" [ngClass]="{'text-green-800': msg.role === 'bot', 'text-amber-800': msg.role === 'user'}">{{ msg.role }}</p>
          <div class="prose max-w-none text-stone-700 whitespace-pre-wrap">
            {{ msg.text }}<span *ngIf="msg.isStreaming" class="inline-block w-0.5 h-5 bg-stone-700 animate-pulse ml-1 translate-y-1"></span>
          </div>
        </div>
      </div>

      <!-- Follow-up Form -->
      <form (ngSubmit)="sendFollowUp()" class="mt-4">
        <div class="flex items-center space-x-2">
          <input
            type="text"
            name="followUpInput"
            [(ngModel)]="followUpInput"
            placeholder="Ask a follow-up question..."
            [disabled]="isGenerating()"
            class="flex-1 px-4 py-2 border border-stone-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-600"
          />
          <button
            type="submit"
            [disabled]="isGenerating() || !followUpInput.trim()"
            class="bg-green-800 text-white p-3 rounded-full hover:bg-green-900 disabled:bg-green-300 transition-colors"
            aria-label="Send follow-up message">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
            </svg>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Image Gallery Section -->
  <div *ngIf="galleryImages().length > 0" class="mt-10">
    <h3 class="text-2xl font-bold text-stone-800 mb-4 border-b pb-2">Gallery</h3>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
      <div *ngFor="let imageUrl of galleryImages()" class="overflow-hidden rounded-lg shadow-md cursor-pointer" (click)="openModal(imageUrl)">
        <img [src]="imageUrl" [alt]="siteData.name + ' gallery image'" class="w-full h-40 object-cover transform hover:scale-105 transition-transform duration-300"/>
      </div>
    </div>
  </div>
</div>

<ng-template #notFound>
  <div class="text-center py-10">
    <h2 class="text-2xl font-bold text-stone-800 mb-4">Site Not Found</h2>
    <p class="text-stone-600 mb-6">We couldn't find the site you were looking for.</p>
    <a routerLink="/sites" class="inline-block bg-amber-800 text-white font-bold py-2 px-4 rounded hover:bg-amber-900 transition-colors">
      Return to Sites List
    </a>
  </div>
</ng-template>

<!-- Image Modal -->
<div *ngIf="selectedImageUrl()" 
     class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 animate-fade-in-fast"
     (click)="closeModal()">
  <div class="relative max-w-4xl max-h-[90vh] p-4" (click)="$event.stopPropagation()">
    <img [src]="selectedImageUrl()?.replace('/400/300', '/1200/900')" 
         alt="Enlarged gallery view" 
         class="object-contain w-full h-full max-h-[85vh] rounded-lg shadow-2xl"/>
    <button (click)="closeModal()" 
            aria-label="Close image view"
            class="absolute top-0 right-0 m-2 bg-white rounded-full p-2 text-stone-700 hover:bg-stone-200 transition-colors focus:outline-none focus:ring-2 focus:ring-white">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
</div>


<style>
@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
    animation: fade-in 0.5s ease-out forwards;
}
@keyframes fade-in-fast {
    from { opacity: 0; }
    to { opacity: 1; }
}
.animate-fade-in-fast {
    animation: fade-in-fast 0.2s ease-out forwards;
}
</style>